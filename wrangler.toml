name = "mohana-worker"
main = "workers/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# 참고: Cloudflare Pages 빌드 출력 디렉토리는 cloudflare-pages.toml 또는 Dashboard에서 설정하세요
# wrangler.toml은 Workers 전용 설정 파일입니다
# Pages 설정은 cloudflare-pages.toml 파일을 사용하거나 Dashboard에서 설정해야 합니다

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "mohana-db"
database_id = "90b1045e-372e-417b-bdea-b77853138f93"

# KV Namespaces
[[kv_namespaces]]
binding = "CACHE"
id = "a532f5a721504b5381f32a18d5a77203"

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "8b74ff8a9c9b408e9fbb357599c5ad2b"

# Queues
[[queues.producers]]
queue = "email-dispatch"
binding = "EMAIL_QUEUE"

[[queues.consumers]]
queue = "email-dispatch"
max_batch_size = 10
max_batch_timeout = 30

[[queues.producers]]
queue = "sms-dispatch"
binding = "SMS_QUEUE"

[[queues.consumers]]
queue = "sms-dispatch"
max_batch_size = 10
max_batch_timeout = 30

[[queues.producers]]
queue = "retry-dispatch"
binding = "RETRY_QUEUE"

# Durable Objects
[[durable_objects.bindings]]
name = "SEQUENCE_SCHEDULER"
class_name = "SequenceScheduler"
script_name = "mohana-worker"

[[migrations]]
tag = "v1"
new_classes = ["SequenceScheduler"]

# Cron Triggers
[triggers]
crons = [
  "*/5 * * * *",  # Queue 재시도 (5분마다)
  "0 * * * *",    # 시퀀스 스텝 스케줄링 (시간당)
  "5 0 * * *",    # 집계 ETL (매일 00:05)
  "15 0 * * 1"    # 링크 헬스 체크 (매주 월요일 00:15)
]

# Environment Variables (로컬 개발용)
[vars]
ENVIRONMENT = "development"

